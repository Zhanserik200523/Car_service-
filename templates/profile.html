<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Профиль - Car Service</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    html, body { height: 100%; }
    body { display: flex; flex-direction: column; }
    .container { flex: 1; }
    .profile-section { background: #fff; border-radius: 8px; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    .section-title { font-size: 1.25rem; margin-bottom: 1rem; border-bottom: 1px solid #eee; padding-bottom: 5px; }
  </style>
</head>
<body class="bg-light">

<!-- Хедер -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <a class="navbar-brand" href="/">Zhans Service</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link active" href="/profile">Профиль</a></li>
        <li class="nav-item"><a class="nav-link" href="/cars">Машины</a></li>
        <li class="nav-item"><a class="nav-link" href="/catalog_products">Продукция</a></li>
        <li class="nav-item"><a class="nav-link" href="/catalog_services">Каталог услуг</a></li>
        <li class="nav-item d-none" id="adminPanelLink"><a class="nav-link" href="/admin_panel">Админка</a></li>
        <li class="nav-item d-none" id="adminProductsLink"><a class="nav-link" href="/products">Товары</a></li>
      </ul>
      <button class="btn btn-outline-light" id="logoutBtn">Выйти</button>
    </div>
  </div>
</nav>

<!-- Контент -->
<div class="container py-5">
  <div class="row g-4">
    <!-- Аватар и базовая инфа -->
    <div class="col-md-4">
      <div class="profile-section">
        <div class="text-center">
          <img id="avatarImage" src="" alt="Аватар" width="120" class="rounded border mb-3">
          <form id="uploadForm">
            <input type="file" id="avatarFile" class="form-control mb-2" accept="image/*">
            <button class="btn btn-primary w-100">Загрузить</button>
          </form>
        </div>
        <p class="mt-3"><i class="bi bi-envelope"></i> Email: <span id="email"></span></p>
        <p><i class="bi bi-person-badge"></i> Роль: <span id="role"></span></p>
      </div>
    </div>

    <!-- Редактирование данных и смена пароля -->
    <div class="col-md-8">
      <div class="profile-section mb-4">
        <div class="section-title">Редактирование данных</div>
        <form id="userDetailsForm">
          <input type="text" id="firstName" class="form-control mb-2" placeholder="Имя">
          <input type="text" id="lastName" class="form-control mb-2" placeholder="Фамилия">
          <input type="text" id="phone" class="form-control mb-2" placeholder="Телефон">
          <button class="btn btn-success">Сохранить</button>
        </form>
        <p id="userDetailsMessage" class="mt-2"></p>
      </div>

      <div class="profile-section mb-4">
        <div class="section-title">Сменить пароль</div>
        <form id="changePasswordForm">
          <input type="password" id="oldPassword" class="form-control mb-2" placeholder="Старый пароль" required>
          <input type="password" id="newPassword" class="form-control mb-2" placeholder="Новый пароль" required>
          <input type="password" id="confirmPassword" class="form-control mb-2" placeholder="Подтвердите новый пароль" required>
          <button class="btn btn-warning">Подтвердить</button>
        </form>
        <p id="changePasswordMessage" class="mt-2"></p>

      </div>

      <div class="profile-section">
        <div class="section-title">Мои записи на ремонт</div>
        <ul id="appointmentsList" class="list-group"></ul>
      </div>
    </div>
  </div>
</div>

<!-- Футер -->
<footer class="bg-dark text-white text-center py-3">
  <div class="container">
    <p class="mb-0">© 2025 Car Service. Все права защищены.</p>
  </div>
</footer>

<!-- JS -->
<script src="/static/profile.js"></script>
<script src="/static/my_appointments.js"></script>
<script src="/static/guard.js"></script>
<script>
  protectPage();
  document.getElementById("logoutBtn").onclick = function () {
    localStorage.removeItem("token");
    window.location.href = "/login";
  };
  async function setupNavigation() {
    const res = await fetch("/api/profile", {
      headers: { Authorization: `Bearer ${localStorage.getItem("token")}` }
    });
    if (res.ok) {
      const user = await res.json();
      if (user.role === "admin") {
        document.getElementById("adminPanelLink").classList.remove("d-none");
        document.getElementById("adminProductsLink").classList.remove("d-none");
      }
    }
  }
  setupNavigation();
</script>
</body>
</html>
